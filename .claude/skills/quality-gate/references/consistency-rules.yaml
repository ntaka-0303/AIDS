# QualityGate Skill - 整合性チェックルール（Consistency）

rules:
  # ========================================
  # 1. decisions矛盾チェック
  # ========================================
  decisions_consistency:
    description: "decisions.yamlの決定事項と成果物内容の整合性を検証"
    severity_default: "Critical"

    rules:
      - id: "CON-DEC-001"
        check: "スコープ外と判定された項目が成果物に含まれていないか"
        method: |
          decisions.yamlで「スコープ外」「対象外」と決定された項目が
          requirements_draft.mdの機能要件に含まれていないことを確認
        severity: "Critical"
        message: "スコープ外と決定された項目「{item}」が要件に含まれています"

      - id: "CON-DEC-002"
        check: "採用しないと決定した技術が計画に含まれていないか"
        method: |
          decisions.yamlで「不採用」「見送り」と決定された技術が
          project_plan_draft.mdに含まれていないことを確認
        severity: "Critical"

      - id: "CON-DEC-003"
        check: "決定事項と矛盾する記載がないか"
        method: |
          decisions.yamlの内容と、成果物の記載に矛盾がないことを確認
          例：「オンプレ採用」の決定後に「クラウド前提」の記載
        severity: "Critical"

  # ========================================
  # 2. ファイルリンク一致チェック
  # ========================================
  file_link_consistency:
    description: "YAMLファイル内の参照先が実在するか検証"
    severity_default: "Warning"

    rules:
      - id: "CON-LINK-001"
        check: "wbs.yaml.deliverableの参照先ファイルが存在するか"
        method: |
          wbs.yamlの各タスクのdeliverableフィールドが
          outputs/ディレクトリに実在するファイルを指しているか確認
        severity: "Warning"
        message: "タスク{task_id}のdeliverable「{path}」が存在しません"

      - id: "CON-LINK-002"
        check: "issues.yaml.relatedの参照先が存在するか"
        method: |
          issues.yamlのrelated.requirements, related.wbs, related.risksが
          それぞれ実在するIDを指しているか確認
        severity: "Warning"

      - id: "CON-LINK-003"
        check: "risks.yaml.relatedの参照先が存在するか"
        method: |
          risks.yamlのrelated.wbs, related.issues, related.decisions, related.hearingsが
          実在するIDまたはファイルを指しているか確認
        severity: "Warning"

  # ========================================
  # 3. リスク↔課題 相互リンクチェック
  # ========================================
  risk_issue_consistency:
    description: "リスクと課題の状態・リンクの整合性を検証"
    severity_default: "Warning"

    rules:
      - id: "CON-RI-001"
        check: "顕在化したリスクがIssue化されているか"
        method: |
          risks.yamlでstatus=Realizedのリスクに対して、
          対応するissues.yamlエントリが存在し、リンクされているか確認
        severity: "Critical"
        message: "リスク{risk_id}(Realized)に対応する課題が登録されていません"

      - id: "CON-RI-002"
        check: "解決済み課題のリンクリスクが適切な状態か"
        method: |
          issues.yamlでstatus=Resolvedの課題にリンクされたリスクが
          Mitigated/Closedになっているか確認
        severity: "Warning"
        message: "課題{issue_id}は解決済みですが、リンクリスク{risk_id}がOpenのままです"

      - id: "CON-RI-003"
        check: "課題がリスクから発生した場合、相互リンクがあるか"
        method: |
          issues.yamlのrelated.risksとrisks.yamlのrelated.issuesの
          双方向リンクが成立しているか確認
        severity: "Info"

  # ========================================
  # 4. WBS整合性チェック
  # ========================================
  wbs_consistency:
    description: "WBS内の整合性を検証"
    severity_default: "Warning"

    rules:
      - id: "CON-WBS-001"
        check: "depends_onの参照先タスクが存在するか"
        method: |
          wbs.yamlの各タスクのdepends_onが
          実在するタスクIDを指しているか確認
        severity: "Warning"

      - id: "CON-WBS-002"
        check: "完了タスクへの依存が残っていないか"
        method: |
          depends_onで指定されたタスクがstatus=Doneの場合、
          依存関係が解消可能であることを示唆
        severity: "Info"

      - id: "CON-WBS-003"
        check: "循環依存がないか"
        method: |
          depends_onを辿って循環参照が発生していないか確認
          A → B → C → A のようなケース
        severity: "Critical"

      - id: "CON-WBS-004"
        check: "due日付の整合性"
        method: |
          depends_onで指定されたタスクのdueより前に
          依存元タスクのdueが設定されていないか確認
        severity: "Warning"
        message: "タスク{task_id}のdue({due})が依存先{dep_id}のdue({dep_due})より前です"

  # ========================================
  # 5. 時系列整合性チェック
  # ========================================
  timeline_consistency:
    description: "日付・時系列の整合性を検証"
    severity_default: "Info"

    rules:
      - id: "CON-TIME-001"
        check: "due < created_atのタスク/課題がないか"
        method: |
          期限が作成日より前に設定されているケースを検出
        severity: "Warning"

      - id: "CON-TIME-002"
        check: "未来日付のResolved/Doneがないか"
        method: |
          status=Resolved/Doneのupdated_atが未来日付でないか確認
        severity: "Warning"

      - id: "CON-TIME-003"
        check: "change_logの時系列順序"
        method: |
          change_log.yamlのエントリが時系列順に記録されているか確認
        severity: "Info"

  # ========================================
  # 6. ドキュメント間整合性チェック
  # ========================================
  cross_document_consistency:
    description: "異なるドキュメント間の整合性を検証"
    severity_default: "Warning"

    rules:
      - id: "CON-DOC-001"
        check: "proposal_draftとproject_plan_draftのスコープ一致"
        method: |
          両ドキュメントのスコープ記載が矛盾していないか確認
        severity: "Critical"

      - id: "CON-DOC-002"
        check: "requirements_draftとproject_plan_draftの要件一致"
        method: |
          要件定義書の要件が計画書のタスクでカバーされているか確認
        severity: "Warning"

      - id: "CON-DOC-003"
        check: "project_charterと各ドキュメントの基本情報一致"
        method: |
          顧客名、プロジェクト名、目的等の基本情報が
          全ドキュメントで一致しているか確認
        severity: "Warning"

# チェック実行順序
execution_order:
  1: decisions_consistency
  2: file_link_consistency
  3: risk_issue_consistency
  4: wbs_consistency
  5: timeline_consistency
  6: cross_document_consistency

# 出力フォーマット
output_format:
  id_prefix: "CON"
  severity_levels:
    - Critical
    - Warning
    - Info
